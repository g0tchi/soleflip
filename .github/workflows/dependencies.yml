name: Dependency Updates

on:
  schedule:
    - cron: '0 2 * * 1' # Weekly on Monday at 2 AM UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  update-python-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install pip-tools
        run: pip install pip-tools
      - name: Check for outdated packages
        run: |
          pip list --outdated --format=json > outdated-packages.json
          cat outdated-packages.json
      - name: Update requirements (if using requirements files)
        run: |
          # This would be used if we had requirements.txt files
          # pip-compile --upgrade requirements.in
          echo "Using pyproject.toml for dependencies"
      - name: Check security vulnerabilities
        run: |
          pip install safety
          safety check --json --output safety-report.json || true
          cat safety-report.json
      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        with:
          name: python-security-report
          path: |
            outdated-packages.json
            safety-report.json
      - name: Create issue for vulnerabilities
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const safetyReport = JSON.parse(fs.readFileSync('safety-report.json', 'utf8'));
              if (safetyReport.vulnerabilities && safetyReport.vulnerabilities.length > 0) {
                github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'Security Vulnerabilities Detected in Python Dependencies',
                  body: `Automated security scan found ${safetyReport.vulnerabilities.length} vulnerabilities:\n\n${JSON.stringify(safetyReport.vulnerabilities, null, 2)}`,
                  labels: ['security', 'dependencies']
                });
              }
            } catch (error) {
              console.log('Could not parse safety report:', error);
            }

  update-node-deps:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./gui
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
          cache-dependency-path: gui/package-lock.json
      - name: Check for outdated packages
        run: |
          npm outdated --json > ../outdated-node-packages.json || true
          cat ../outdated-node-packages.json
      - name: Audit packages for vulnerabilities
        run: |
          npm audit --audit-level moderate --json > ../npm-audit-report.json || true
          cat ../npm-audit-report.json
      - name: Upload Node.js reports
        uses: actions/upload-artifact@v4
        with:
          name: node-security-report
          path: |
            outdated-node-packages.json
            npm-audit-report.json
      - name: Create issue for Node vulnerabilities
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const auditReport = JSON.parse(fs.readFileSync('npm-audit-report.json', 'utf8'));
              if (auditReport.metadata && auditReport.metadata.vulnerabilities.total > 0) {
                github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'Security Vulnerabilities Detected in Node.js Dependencies',
                  body: `Automated security scan found ${auditReport.metadata.vulnerabilities.total} vulnerabilities:\n\nHigh: ${auditReport.metadata.vulnerabilities.high}\nModerate: ${auditReport.metadata.vulnerabilities.moderate}\nLow: ${auditReport.metadata.vulnerabilities.low}`,
                  labels: ['security', 'dependencies', 'frontend']
                });
              }
            } catch (error) {
              console.log('Could not parse npm audit report:', error);
            }
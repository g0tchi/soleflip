{
  "name": "Price Alert Automation",
  "description": "Monitor price changes and send alerts for profitable opportunities",
  "trigger": {
    "type": "schedule",
    "interval": "*/15 * * * *",
    "description": "Run every 15 minutes"
  },
  "steps": [
    {
      "name": "fetch_new_opportunities",
      "type": "query",
      "datasource": "soleflip_api",
      "query": "getQuickFlipOpportunities",
      "parameters": {
        "min_profit_margin": 40,
        "limit": 50
      }
    },
    {
      "name": "filter_high_value",
      "type": "filter",
      "condition": "{{ data.gross_profit > 50 }}",
      "description": "Only opportunities with >â‚¬50 profit"
    },
    {
      "name": "check_new_opportunities",
      "type": "conditional",
      "condition": "{{ filtered_data.length > 0 }}",
      "true_steps": [
        {
          "name": "format_alert_message",
          "type": "javascript",
          "code": `
            const opportunities = data;
            const total = opportunities.length;
            const bestOpportunity = opportunities.reduce((best, current) =>
              current.profit_margin > best.profit_margin ? current : best
            );

            return {
              subject: \`ðŸš€ \${total} High-Profit Opportunities Found!\`,
              message: \`
                ðŸ“Š **New QuickFlip Opportunities**

                **Total Opportunities:** \${total}
                **Best Opportunity:**
                â€¢ Product: \${bestOpportunity.product_name}
                â€¢ Buy Price: â‚¬\${bestOpportunity.buy_price}
                â€¢ Sell Price: â‚¬\${bestOpportunity.sell_price}
                â€¢ Profit: â‚¬\${bestOpportunity.gross_profit} (\${bestOpportunity.profit_margin}% margin)
                â€¢ Source: \${bestOpportunity.buy_source}

                **All Opportunities:**
                \${opportunities.map(op =>
                  \`â€¢ \${op.product_name}: â‚¬\${op.gross_profit} profit (\${op.profit_margin}%)\`
                ).join('\\n')}

                ðŸ”— View in Budibase: [QuickFlip Dashboard](/quickflip)
              \`
            };
          `
        },
        {
          "name": "send_email_alert",
          "type": "email",
          "to": "{{ env.ALERT_EMAIL }}",
          "subject": "{{ format_alert_message.subject }}",
          "body": "{{ format_alert_message.message }}",
          "html": true
        },
        {
          "name": "log_alert",
          "type": "log",
          "level": "info",
          "message": "Price alert sent for {{ filtered_data.length }} opportunities"
        }
      ],
      "false_steps": [
        {
          "name": "log_no_opportunities",
          "type": "log",
          "level": "debug",
          "message": "No high-profit opportunities found in this cycle"
        }
      ]
    }
  ],
  "error_handling": {
    "on_error": [
      {
        "name": "log_error",
        "type": "log",
        "level": "error",
        "message": "Price alert automation failed: {{ error.message }}"
      }
    ],
    "retry": {
      "attempts": 3,
      "delay": 30000
    }
  },
  "settings": {
    "enabled": true,
    "timezone": "Europe/Berlin",
    "max_runtime": 300000
  }
}